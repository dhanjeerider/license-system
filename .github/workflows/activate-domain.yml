name: Activate Domain

on:
  repository_dispatch:
    types: [activate-domain]

jobs:
  activate:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Activate
      run: |
        DOMAIN="${{ github.event.client_payload.domain }}"
        FILE="domains/list.json"

        node <<EOF
        const fs = require("fs");
        const f = "domains/list.json";
        const d = JSON.parse(fs.readFileSync(f));
        const domain = process.env.DOMAIN;

        d.pending = d.pending.filter(x => x !== domain);
        if (!d.active.includes(domain)) d.active.push(domain);

        fs.writeFileSync(f, JSON.stringify(d, null, 2));
        EOF

    - name: Commit
      run: |
        git config user.name "Auto Bot"
        git config user.email "bot@github.com"
        git add .
        git commit -m "Activate domain"
        git push
