name: Activate Domain
on:
  repository_dispatch:
    types: [activate-domain]

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Activate domain
      run: |
        echo "DOMAIN=${{ github.event.client_payload.domain }}" >> $GITHUB_ENV

        node <<'EOF'
        const fs = require("fs");
        const file = "domains/list.json";
        const d = JSON.parse(fs.readFileSync(file));
        const domain = process.env.DOMAIN;

        d.pending = d.pending.filter(x => x !== domain);
        if (!d.active.includes(domain)) d.active.push(domain);

        fs.writeFileSync(file, JSON.stringify(d,null,2));
        EOF

    - name: Commit
      run: |
        git config user.name "Auto Bot"
        git config user.email "bot@github.com"
        git add .
        git commit -m "Activated domain" || echo "No changes"
        git push
