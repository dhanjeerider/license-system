name: Add Domain
on:
  repository_dispatch:
    types: [add-domain]

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Add domain to list.json
      run: |
        echo "DOMAIN=${{ github.event.client_payload.domain }}" >> $GITHUB_ENV

        node <<'EOF'
        const fs = require("fs");
        const file = "domains/list.json";
        const d = JSON.parse(fs.readFileSync(file));
        const domain = process.env.DOMAIN;

        if (!d.pending.includes(domain) && !d.active.includes(domain)) {
          d.pending.push(domain);
        }

        fs.writeFileSync(file, JSON.stringify(d,null,2));
        EOF

    - name: Commit
      run: |
        git config user.name "Auto Bot"
        git config user.email "bot@github.com"
        git add .
        git commit -m "Add domain" || echo "No changes"
        git push
